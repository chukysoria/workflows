---
  name: Release Drafter
  
  on:
    workflow_call:
      inputs:
        config-file:
          description: Config file path
          default: config.yaml
          required: false
          type: string
  
  jobs:
    update_release_draft:
      name: ✏️ Draft release
      runs-on: ubuntu-latest
      outputs:
        publish: ${{ steps.publish.outputs.publish }}
        version: ${{ steps.drafter.outputs.tag_name }}
        body: ${{ steps.drafter.outputs.body }}
      permissions:
        contents: write  # for release-drafter/release-drafter to create a github release
        pull-requests: read  # for release-drafter/release-drafter to read PR content and labels
      steps:
        - name: ⤵️ Check out code from GitHub
          uses: actions/checkout@v4.1.0
          with:
            fetch-depth: 2

        - name: Check for new version pushed
          uses: salsify/action-detect-and-tag-new-version@v2
          id: version
          with:
            create-tag: false
            version-command: |
              yq e '.version' "${{ inputs.config-file }}"

        - name: If new version, the publish release
          id: publish
          run: |
            echo "publish=${{ steps.version.outputs.previous-version != steps.version.outputs.current-version}}" >> $GITHUB_OUTPUT
        
        - name: 🚀 Run Release Drafter
          uses: release-drafter/release-drafter@v5.24.0
          id: drafter
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            publish: ${{ steps.publish.outputs.publish }}
    
    create-pr:
      name: Create new version Pull Request
      needs:
        - update_release_draft
      runs-on: ubuntu-latest
      if: needs.update_release_draft.outputs.publish == 'false'
      permissions:
        pull-requests: write
      steps:
        - name: Checkout config
          uses: actions/checkout@v4.1.0
          with:
            sparse-checkout: |
              ${{ inputs.config-file }}
            sparse-checkout-cone-mode: false
          
        - name: Update version
          run: |
            sed -i "s/^version: .*/version: ${{ needs.update_release_draft.outputs.version }}/" "${{ inputs.config-file }}"

        - name: Create Pull Request
          uses: peter-evans/create-pull-request@v5.0.0
          with:
            branch: releases/new-release
            delete-branch: true
            title: Bump to version ${{ needs.update_release_draft.outputs.version }}
            body: ${{ needs.update_release_draft.outputs.body }}
            assignees: ${{ github.repository_owner }}
            labels: bump-version
            add-paths: |
              ${{ inputs.config-file }}
