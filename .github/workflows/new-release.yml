---
  name: âœï¸ Release Drafter
  
  on:
    workflow_call:
      inputs:
        config-file:
          description: Config file path
          default: config.yaml
          required: false
          type: string
        tag-external-version:
          description: Include tag for the external version of the app
          default: false
          required: false
          type: boolean
        prerelease:
          description: Flag as a pre release version
          default: false
          required: false
          type: boolean
        prerelease-identifier:
          description: A string indicating an identifier (alpha, beta, rc, etc), to increment the prerelease version. number
          default: dev
          required: false
          type: string
        simple-build:
          description: Set it true if there's no architectures
          default: false
          required: false
          type: boolean
  
  env:
    BRANCH_NAME: ${{ github.base_ref || github.ref_name }}

  jobs:
    check_for_new_version:
      name: â„¹ï¸ Check for new version
      runs-on: ubuntu-latest
      outputs:
        publish: ${{ steps.publish.outputs.publish }}
        new-version: ${{ steps.version.outputs.current-version }}
      steps:
        - name: â¤µï¸ Check out code from GitHub
          uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
          with:
            fetch-depth: 2
            sparse-checkout: |
              ${{ inputs.config-file }}
            sparse-checkout-cone-mode: false

        - name: â„¹ï¸ Check for new version pushed
          uses: salsify/action-detect-and-tag-new-version@v2
          id: version
          with:
            create-tag: false
            version-command: |
              yq e '.version' "${{ inputs.config-file }}"

        - name: â„¹ï¸ If new version, the publish release
          id: publish
          run: |
            echo "publish=${{ steps.version.outputs.previous-version != steps.version.outputs.current-version}}" >> $GITHUB_OUTPUT
  
    update_release_draft:
      name: âœï¸ Draft release
      runs-on: ubuntu-latest
      needs:
        - check_for_new_version
      outputs:
        version: ${{ steps.drafter.outputs.tag_name }}
        body: ${{ steps.drafter.outputs.body }}
      permissions:
        contents: write  # for release-drafter/release-drafter to create a github release
        pull-requests: read  # for release-drafter/release-drafter to read PR content and labels
      steps:     
        - name: ğŸš€ Publish Release
          uses: release-drafter/release-drafter@b1476f6e6eb133afa41ed8589daba6dc69b4d3f5 # v6.1.0
          id: release-publish
          if: needs.check_for_new_version.outputs.publish == 'true'
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            publish: ${{ needs.check_for_new_version.outputs.publish }}
            prerelease: ${{ inputs.prerelease }}
            prerelease-identifier: ${{ inputs.prerelease-identifier }}
            version: ${{ needs.check_for_new_version.outputs.new-version }}
        - name: ğŸš€ Run Release Drafter
          uses: release-drafter/release-drafter@b1476f6e6eb133afa41ed8589daba6dc69b4d3f5 # v6.1.0
          id: drafter
          if: needs.check_for_new_version.outputs.publish == 'false'
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            publish: ${{ needs.check_for_new_version.outputs.publish }}
            prerelease: ${{ inputs.prerelease }}
            prerelease-identifier: ${{ inputs.prerelease-identifier }}

    check-build:
      name: â„¹ï¸ Check if a build trigger is configured
      needs:
        - check_for_new_version
      runs-on: ubuntu-latest
      if: needs.check_for_new_version.outputs.publish == 'true'
      outputs:
        build: ${{ steps.check-build-yml.outputs.build }}
      steps:
        - name: â¤µï¸ Check out code from GitHub
          uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

        - id: check-build-yml
          name: â„¹ï¸ Checks for build.yaml file
          run: |
           echo "build=$( [ -f 'build.yaml' ] && echo 'true' || echo 'false' )"  >> $GITHUB_OUTPUT

    publish-build:
      name: ğŸš€ Publish build
      needs:
        - check-build
      if: needs.check-build.outputs.build == 'true' && inputs.simple-build == false
      uses: ./.github/workflows/build-image.yml
      with:
        publish: true
        tag-external-version: ${{ inputs.tag-external-version }}

    publish-build-simple:
      name: ğŸš€ Publish simple build
      needs:
        - check-build
      if: needs.check-build.outputs.build == 'true' && inputs.simple-build == true
      uses: ./.github/workflows/build-image-simple.yml
      with:
        publish: true
        tag-external-version: ${{ inputs.tag-external-version }}

    create-pr:
      name: âœï¸ Create new version Pull Request
      needs:
        - update_release_draft
        - check_for_new_version
      runs-on: ubuntu-latest
      if: needs.check_for_new_version.outputs.publish == 'false'
      permissions:
        contents: write
        pull-requests: write
      steps:
        - name: â¤µï¸ Checkout config
          uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
          with:
            sparse-checkout: |
              ${{ inputs.config-file }}
            sparse-checkout-cone-mode: false
          
        - name: ğŸš€ Update version
          run: |
            sed -i "s/^version: .*/version: ${{ needs.update_release_draft.outputs.version }}/" "${{ inputs.config-file }}"

        - name: âœï¸ Create Pull Request
          uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7.0.11
          with:
            branch: releases/new-release-${{ env.BRANCH_NAME }}
            delete-branch: true
            title: Bump to version ${{ needs.update_release_draft.outputs.version }}
            body: ${{ needs.update_release_draft.outputs.body }}
            assignees: ${{ github.repository_owner }}
            labels: bump-version
            add-paths: |
              ${{ inputs.config-file }}
